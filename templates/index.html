<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Finansal Asistanƒ±m - Python Flask</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .fade-in {
        animation: fadeIn 0.3s ease-out;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 min-h-screen"
  >
    <div class="max-w-7xl mx-auto p-4">
      <div class="text-center mb-8 pt-6">
        <h1
          class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2"
        >
          Finansal Asistanƒ±m üêç
        </h1>
        <p class="text-gray-600">Python Flask ile B√ºt√ße Takibi</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div
          class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-green-500 transform hover:scale-105 transition-transform"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm mb-1">Toplam Gelir</p>
              <p class="text-3xl font-bold text-green-600" id="total-income">
                ‚Ç∫0.00
              </p>
            </div>
            <span class="text-5xl">üìà</span>
          </div>
        </div>

        <div
          class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-red-500 transform hover:scale-105 transition-transform"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm mb-1">Toplam Gider</p>
              <p class="text-3xl font-bold text-red-600" id="total-expense">
                ‚Ç∫0.00
              </p>
            </div>
            <span class="text-5xl">üìâ</span>
          </div>
        </div>

        <div
          class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-blue-500 transform hover:scale-105 transition-transform"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm mb-1">Net Bakiye</p>
              <p class="text-3xl font-bold text-blue-600" id="balance">‚Ç∫0.00</p>
            </div>
            <span class="text-5xl">üí∞</span>
          </div>
        </div>
        <div
          class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-orange-500 transform hover:scale-105 transition-transform"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm mb-1">Bug√ºnk√º Harcama</p>
              <p id="today-expense" class="text-3xl font-bold text-orange-600">
                ‚Ç∫0.00
              </p>
            </div>
            <span class="text-5xl">üî•</span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col">
          <h3 class="text-xl font-bold mb-4 text-gray-800">Harcama Daƒüƒ±lƒ±mƒ±</h3>
          <div class="relative h-64 w-full">
            <canvas id="pieChart"></canvas>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col">
          <h3 class="text-xl font-bold mb-4 text-gray-800">Aylƒ±k Analiz</h3>
          <div class="relative h-64 w-full">
            <canvas id="barChart"></canvas>
          </div>
        </div>
      </div>

      <!-- ƒ∞STATƒ∞STƒ∞KLER -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-xl p-4">
          <p class="text-sm text-gray-500">Ortalama Gider</p>
          <p id="avg-expense" class="text-xl font-bold text-purple-700"></p>
        </div>

        <div class="bg-white rounded-xl p-4">
          <p class="text-sm text-gray-500">En Y√ºksek Gider</p>
          <p id="max-expense" class="text-xl font-bold text-red-600"></p>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
        <div class="flex flex-wrap gap-4 items-center justify-between">
          <div class="flex flex-wrap gap-3">
            <select
              id="filter-type"
              class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
            >
              <option value="all">T√ºm√º</option>
              <option value="income">Gelirler</option>
              <option value="expense">Giderler</option>
            </select>

            <select
              id="filter-period"
              class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
            >
              <option value="all">T√ºm Zamanlar</option>
              <option value="today">Bug√ºn</option>
              <option value="week">Son 7 G√ºn</option>
              <option value="month">Son Ay</option>
              <option value="year">Son Yƒ±l</option>
            </select>
          </div>
          <button
            onclick="window.location.href='/api/transactions/export/excel'"
            class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-5 py-2 rounded-lg shadow-md"
          >
            üìä Excel Raporu
          </button>
          <button
            onclick="showAddModal()"
            class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-lg flex items-center gap-2 hover:from-purple-600 hover:to-pink-600 transition-all shadow-md"
          >
            <span class="text-xl">‚ûï</span>
            Yeni ƒ∞≈ülem
          </button>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-6">
        <h3 class="text-xl font-bold mb-4 text-gray-800">ƒ∞≈ülem Ge√ßmi≈üi</h3>
        <div id="transactions-list" class="space-y-3"></div>
      </div>
    </div>

    <div
      id="modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"
    >
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 fade-in">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-gray-800" id="modal-title">
            Yeni ƒ∞≈ülem Ekle
          </h3>
          <button
            onclick="closeModal()"
            class="text-gray-500 hover:text-gray-700 text-2xl"
          >
            ‚úñÔ∏è
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >T√ºr</label
            >
            <div class="grid grid-cols-2 gap-3">
              <button
                onclick="selectType('income')"
                id="btn-income"
                class="py-3 rounded-lg font-medium transition-all bg-gray-100 text-gray-600 hover:bg-gray-200"
              >
                üí∞ Gelir
              </button>
              <button
                onclick="selectType('expense')"
                id="btn-expense"
                class="py-3 rounded-lg font-medium transition-all bg-red-500 text-white shadow-md"
              >
                üí∏ Gider
              </button>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Tutar (‚Ç∫)</label
            >
            <input
              type="number"
              step="0.01"
              id="input-amount"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
              placeholder="0.00"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Kategori</label
            >
            <select
              id="input-category"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
            >
              <option value="">Kategori Se√ßin</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >A√ßƒ±klama</label
            >
            <input
              type="text"
              id="input-description"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
              placeholder="A√ßƒ±klama ekleyin..."
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Tarih</label
            >
            <input
              type="date"
              id="input-date"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
            />
          </div>

          <button
            onclick="saveTransaction()"
            class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-medium hover:from-purple-600 hover:to-pink-600 transition-all shadow-md flex items-center justify-center gap-2"
          >
            <span class="text-xl">üíæ</span>
            <span id="save-btn-text">Kaydet</span>
          </button>
        </div>
      </div>
    </div>

    <script>
      let transactions = [];
      let editingId = null;
      let currentType = "expense";
      let pieChart = null;
      let barChart = null;

      const categories = {
        expense: [
          "Yiyecek & ƒ∞√ßecek",
          "Ula≈üƒ±m",
          "Faturalar",
          "Eƒülence",
          "Alƒ±≈üveri≈ü",
          "Saƒülƒ±k",
          "Eƒüitim",
          "Diƒüer",
        ],
        income: ["Maa≈ü", "Yatƒ±rƒ±m", "Freelance", "Hediye", "Diƒüer"],
      };

      const categoryColors = {
        "Yiyecek & ƒ∞√ßecek": "#FF6B6B",
        Ula≈üƒ±m: "#4ECDC4",
        Faturalar: "#45B7D1",
        Eƒülence: "#FFA07A",
        Alƒ±≈üveri≈ü: "#98D8C8",
        Saƒülƒ±k: "#FF89B5",
        Eƒüitim: "#95E1D3",
        Diƒüer: "#B8B8D1",
        Maa≈ü: "#6BCF7F",
        Yatƒ±rƒ±m: "#4A90E2",
        Freelance: "#9B59B6",
        Hediye: "#F39C12",
      };

      // Load transactions
      async function loadTransactions() {
        const response = await fetch("/api/transactions");
        transactions = await response.json();
        updateUI();
      }

      function todayExpense() {
        const today = new Date().toISOString().split("T")[0];
        const total = transactions
          .filter((t) => t.type === "expense" && t.date === today)
          .reduce((s, t) => s + t.amount, 0);

        document.getElementById(
          "today-expense"
        ).textContent = `‚Ç∫${total.toFixed(2)}`;
      }

      // Add/Update transaction
      async function saveTransaction() {
        const amount = document.getElementById("input-amount").value;
        const category = document.getElementById("input-category").value;
        const description = document.getElementById("input-description").value;
        const date = document.getElementById("input-date").value;

        if (!amount || !category) {
          alert("L√ºtfen t√ºm alanlarƒ± doldurun");
          return;
        }

        const data = {
          type: currentType,
          amount: parseFloat(amount),
          category,
          description,
          date,
        };

        if (editingId) {
          await fetch(`/api/transactions/${editingId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
        } else {
          await fetch("/api/transactions", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
        }

        closeModal();
        loadTransactions();
      }

      // Delete transaction
      async function deleteTransaction(id) {
        if (confirm("Bu i≈ülemi silmek istediƒüinizden emin misiniz?")) {
          await fetch(`/api/transactions/${id}`, { method: "DELETE" });
          loadTransactions();
        }
      }

      // Edit transaction
      function editTransaction(id) {
        const transaction = transactions.find((t) => t.id === id);
        if (!transaction) return;

        editingId = id;
        currentType = transaction.type;

        document.getElementById("modal-title").textContent = "ƒ∞≈ülemi D√ºzenle";
        document.getElementById("save-btn-text").textContent = "G√ºncelle";
        document.getElementById("input-amount").value = transaction.amount;
        document.getElementById("input-description").value =
          transaction.description;
        document.getElementById("input-date").value = transaction.date;

        selectType(transaction.type);
        document.getElementById("input-category").value = transaction.category;

        document.getElementById("modal").classList.remove("hidden");
      }

      // UI Functions
      function showAddModal() {
        editingId = null;
        currentType = "expense";
        document.getElementById("modal-title").textContent = "Yeni ƒ∞≈ülem Ekle";
        document.getElementById("save-btn-text").textContent = "Kaydet";
        document.getElementById("input-amount").value = "";
        document.getElementById("input-category").value = "";
        document.getElementById("input-description").value = "";
        document.getElementById("input-date").value = new Date()
          .toISOString()
          .split("T")[0];
        selectType("expense");
        document.getElementById("modal").classList.remove("hidden");
      }

      function closeModal() {
        document.getElementById("modal").classList.add("hidden");
        editingId = null;
      }

      function selectType(type) {
        currentType = type;
        const incomeBtn = document.getElementById("btn-income");
        const expenseBtn = document.getElementById("btn-expense");
        const categorySelect = document.getElementById("input-category");

        if (type === "income") {
          incomeBtn.className =
            "py-3 rounded-lg font-medium transition-all bg-green-500 text-white shadow-md";
          expenseBtn.className =
            "py-3 rounded-lg font-medium transition-all bg-gray-100 text-gray-600 hover:bg-gray-200";
        } else {
          expenseBtn.className =
            "py-3 rounded-lg font-medium transition-all bg-red-500 text-white shadow-md";
          incomeBtn.className =
            "py-3 rounded-lg font-medium transition-all bg-gray-100 text-gray-600 hover:bg-gray-200";
        }

        categorySelect.innerHTML = '<option value="">Kategori Se√ßin</option>';
        categories[type].forEach((cat) => {
          categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
        });
      }

      function getFilteredTransactions() {
        const filterType = document.getElementById("filter-type").value;
        const filterPeriod = document.getElementById("filter-period").value;

        let filtered = transactions;

        if (filterType !== "all") {
          filtered = filtered.filter((t) => t.type === filterType);
        }

        if (filterPeriod !== "all") {
          const now = new Date();
          const periodStart = new Date();

          switch (filterPeriod) {
            case "today":
              periodStart.setHours(0, 0, 0, 0);
              break;
            case "week":
              periodStart.setDate(now.getDate() - 7);
              break;
            case "month":
              periodStart.setMonth(now.getMonth() - 1);
              break;
            case "year":
              periodStart.setFullYear(now.getFullYear() - 1);
              break;
          }

          filtered = filtered.filter((t) => new Date(t.date) >= periodStart);
        }

        return filtered;
      }

      function updateUI() {
        const filtered = getFilteredTransactions();

        // Update stats
        const totalIncome = filtered
          .filter((t) => t.type === "income")
          .reduce((sum, t) => sum + t.amount, 0);
        const totalExpense = filtered
          .filter((t) => t.type === "expense")
          .reduce((sum, t) => sum + t.amount, 0);
        const balance = totalIncome - totalExpense;

        document.getElementById(
          "total-income"
        ).textContent = `‚Ç∫${totalIncome.toLocaleString("tr-TR", {
          minimumFractionDigits: 2,
        })}`;
        document.getElementById(
          "total-expense"
        ).textContent = `‚Ç∫${totalExpense.toLocaleString("tr-TR", {
          minimumFractionDigits: 2,
        })}`;
        document.getElementById(
          "balance"
        ).textContent = `‚Ç∫${balance.toLocaleString("tr-TR", {
          minimumFractionDigits: 2,
        })}`;
        document.getElementById("balance").className = `text-3xl font-bold ${
          balance >= 0 ? "text-blue-600" : "text-red-600"
        }`;

        // Update transactions list
        const listContainer = document.getElementById("transactions-list");
        if (filtered.length === 0) {
          listContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <p class="text-5xl mb-3">üìã</p>
                        <p>Hen√ºz i≈ülem yok. Yeni bir i≈ülem ekleyerek ba≈ülayƒ±n!</p>
                    </div>
                `;
        } else {
          listContainer.innerHTML = filtered
            .map(
              (t) => `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: ${
                              categoryColors[t.category]
                            }20;">
                                <span class="text-2xl">${
                                  t.type === "income" ? "üí∞" : "üí∏"
                                }</span>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">${
                                  t.category
                                }</p>
                                <p class="text-sm text-gray-500">${
                                  t.description
                                }</p>
                                <p class="text-xs text-gray-400">${new Date(
                                  t.date
                                ).toLocaleDateString("tr-TR")}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <p class="text-xl font-bold ${
                              t.type === "income"
                                ? "text-green-600"
                                : "text-red-600"
                            }">
                                ${
                                  t.type === "income" ? "+" : "-"
                                }‚Ç∫${t.amount.toLocaleString("tr-TR", {
                minimumFractionDigits: 2,
              })}
                            </p>
                            <button onclick="editTransaction(${
                              t.id
                            })" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg transition-colors">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="deleteTransaction(${
                              t.id
                            })" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `
            )
            .join("");
        }

        updateCharts(filtered);
        todayExpense();
      }
      async function loadStatistics() {
        const res = await fetch("/api/statistics");
        const data = await res.json();

        document.getElementById(
          "avg-expense"
        ).textContent = `Ortalama Gider: ‚Ç∫${data.avg_expense.toFixed(2)}`;

        document.getElementById(
          "max-expense"
        ).textContent = `En Y√ºksek Gider: ‚Ç∫${data.max_expense.toFixed(2)}`;
      }

      loadStatistics();

      function exportCSV() {
        window.location.href = "/api/transactions/export/csv";
      }

      function updateCharts(filtered) {
        // Pie Chart Data
        const categoryData = filtered
          .filter((t) => t.type === "expense")
          .reduce((acc, t) => {
            acc[t.category] = (acc[t.category] || 0) + t.amount;
            return acc;
          }, {});

        const pieData = Object.entries(categoryData);

        if (pieChart) pieChart.destroy();

        if (pieData.length > 0) {
          const ctx = document.getElementById("pieChart").getContext("2d");
          pieChart = new Chart(ctx, {
            type: "pie",
            data: {
              labels: pieData.map(([name]) => name),
              datasets: [
                {
                  data: pieData.map(([, value]) => value),
                  backgroundColor: pieData.map(
                    ([name]) => categoryColors[name]
                  ),
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: "bottom" },
              },
            },
          });
        }

        // Bar Chart Data
        const monthlyData = filtered.reduce((acc, t) => {
          const month = new Date(t.date).toLocaleDateString("tr-TR", {
            month: "short",
            year: "numeric",
          });
          if (!acc[month]) {
            acc[month] = { month, income: 0, expense: 0 };
          }
          if (t.type === "income") {
            acc[month].income += t.amount;
          } else {
            acc[month].expense += t.amount;
          }
          return acc;
        }, {});

        const barData = Object.values(monthlyData)
          .reverse()
          .slice(0, 6)
          .reverse();

        if (barChart) barChart.destroy();

        if (barData.length > 0) {
          const ctx = document.getElementById("barChart").getContext("2d");
          barChart = new Chart(ctx, {
            type: "bar",
            data: {
              labels: barData.map((d) => d.month),
              datasets: [
                {
                  label: "Gelir",
                  data: barData.map((d) => d.income),
                  backgroundColor: "#6BCF7F",
                },
                {
                  label: "Gider",
                  data: barData.map((d) => d.expense),
                  backgroundColor: "#FF6B6B",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: "bottom" },
              },
            },
          });
        }
      }

      // Event listeners
      document
        .getElementById("filter-type")
        .addEventListener("change", updateUI);
      document
        .getElementById("filter-period")
        .addEventListener("change", updateUI);

      // Initialize
      document.getElementById("input-date").value = new Date()
        .toISOString()
        .split("T")[0];
      loadTransactions();
    </script>
  </body>
</html>
